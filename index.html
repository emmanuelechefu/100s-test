<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>100s Test</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --red:#f01212;
      --black:#0b0b0b;
      --pill:#111;
      --grey:#dcdcdc;
      --light:#f7f7f7;
      --outline:#111;
      --radius:42px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:#fff; color:#000; font-family:"Space Mono", monospace;
      display:flex; min-height:100vh; align-items:center; justify-content:center;
    }
    #app{width:min(1000px,94vw); padding:28px 14px 60px; position:relative}

    /* Top bar */
    .topbar{position:fixed; left:20px; right:20px; top:10px; display:flex; align-items:center; justify-content:space-between; pointer-events:none}
    .topbar > *{pointer-events:auto}
    .highscore{font-weight:700; letter-spacing:1px}
    .icons{display:flex; gap:16px}
    .iconbtn{width:36px; height:36px; border-radius:50%; border:3px solid var(--outline); background:#fff; display:grid; place-items:center; cursor:pointer}
    .iconbtn:hover{box-shadow:0 0 0 6px rgba(0,0,0,.06)}
    .trophy{color:#f2b705; font-weight:900}
    .gear{position:relative}

    h1.title{margin:54px 0 24px; text-align:center; font-size:40px; letter-spacing:2px}
    h1.title span{color:var(--red);}

    /* Buttons */
    .btn{cursor:pointer; user-select:none; border:none; outline:none; font-family:inherit; font-weight:700; letter-spacing:1px}
    .pill{padding:18px 34px; border-radius:var(--radius); border:5px solid var(--outline); background:var(--pill); color:#fff; font-size:22px; display:block; width:min(420px,92%); margin:18px auto; transition:all .15s}
    .pill:hover{box-shadow:0 0 0 6px rgba(0,0,0,.06)}
    .pill.alt{background:#fff; color:#000}
    .pill.primary{background:var(--red); color:#fff}
    .pill.primary:hover{box-shadow:0 0 0 6px rgba(0,0,0,.06), 0 6px 0 0 rgba(0,0,0,.08)}

    .small{padding:10px 22px; border-radius:28px; font-size:18px}

    .row{display:flex; gap:20px; flex-wrap:wrap; align-items:center; justify-content:center}

    /* Toggle checkboxes */
    .toggles{display:grid; grid-template-columns:1fr 1fr; gap:28px 64px; justify-items:start; width:min(720px,96%); margin:22px auto}
    .toggle{display:flex; align-items:center; gap:14px; font-size:34px}
    .check{width:28px; height:28px; border:5px solid #000; border-radius:4px; display:inline-grid; place-items:center; cursor:pointer; background:#fff}
    .dot{width:14px; height:14px; border-radius:50%; background:var(--red); opacity:.0; transition:.15s}
    .check.on .dot{opacity:1}

    .center{ text-align:center }

    /* Timer / counter badge */
    .oval{display:inline-block; min-width:140px; padding:12px 22px; border-radius:40px; border:6px solid #000; background:#fff; font-size:26px; font-weight:700; text-align:center}

    /* Game panel */
    .panel{border:6px solid #000; padding:26px; border-radius:16px; width:min(720px,96%); margin:16px auto}
    .question{font-size:48px; text-align:center; margin:20px 0}
    .qnum{font-weight:700; margin-left:8px}

    .answer{display:block; width:min(520px,92%); margin:18px auto; padding:10px; font-size:28px; border:0; border-bottom:6px solid #000; outline:none; text-align:center}

    .countdown{position:fixed; inset:0; display:none; align-items:center; justify-content:center;}
    .countdown > div{background:var(--red); color:#fff; font-size:64px; font-weight:700; padding:28px 90px; border-radius:10px; border:12px solid #000}

    .footerBtns{margin-top:18px; display:flex; gap:18px; justify-content:center}

    /* Forms */
    .timeSet{display:flex; align-items:center; gap:16px; justify-content:center; margin:8px 0 16px}
    .timeSet input{width:120px; text-align:center; padding:8px 10px; font-size:22px; border-radius:28px; border:6px solid #000; outline:none}

    /* Tables */
    table{border-collapse:collapse; width:min(560px,96%); margin:16px auto}
    th,td{border:2px solid #000; padding:8px 10px; text-align:center}
    th{background:#ffefad}

    /* Links */
    a.likeBtn{color:inherit; text-decoration:none}

    /* Hideable views */
    .view{display:none}
    .view.active{display:block}

    /* Hover specifics from the spec */
    .pill.alt:hover, .pill:hover{outline:0; box-shadow:0 0 0 6px rgba(0,0,0,.06)}
    .pill.alt:hover{color:#000}

    /* Utility */
    .mt-24{margin-top:24px}
    .mb-12{margin-bottom:12px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="highscore">HIGHSCORE: <span id="highscore100s">‚Äî</span></div>
    <div class="icons">
      <button class="iconbtn" id="btnLeaderboard" title="Leaderboard">üèÜ</button>
      <button class="iconbtn" id="btnSettings" title="Settings">‚öôÔ∏è</button>
    </div>
  </div>
  <div id="app">
    <h1 class="title"><span>100s</span> Test</h1>

    <!-- MAIN MENU -->
    <section id="menu" class="view active center">
      <button class="pill primary" data-nav="setup-100s">100s Mode</button>
      <button class="pill alt" data-nav="setup-ta">Time Attack Mode</button>
      <button class="pill" data-nav="setup-practice">Practice</button>
    </section>

    <!-- 100s SETUP -->
    <section id="setup-100s" class="view">
      <h2 class="center">100s MODE ‚Äì Setup</h2>
      <div class="toggles" id="ops100s"></div>
      <div class="footerBtns">
        <button class="pill" id="start100s">START</button>
        <button class="pill primary small" data-nav="menu">BACK</button>
      </div>
    </section>

    <!-- TIME ATTACK SETUP -->
    <section id="setup-ta" class="view">
      <h2 class="center">TIME ATTACK ‚Äì Setup</h2>
      <div class="timeSet">
        <label for="taTime"><b>Set Time</b></label>
        <input id="taTime" value="00:30" maxlength="5" />
      </div>
      <div class="toggles" id="opsTA"></div>
      <div class="footerBtns">
        <button class="pill" id="startTA">START</button>
        <button class="pill primary small" data-nav="menu">BACK</button>
      </div>
    </section>

    <!-- PRACTICE SETUP -->
    <section id="setup-practice" class="view">
      <h2 class="center">PRACTICE MODE ‚Äì Setup</h2>
      <div class="toggles" id="opsPractice"></div>
      <div class="footerBtns">
        <button class="pill" id="startPractice">START</button>
        <button class="pill primary small" data-nav="menu">BACK</button>
      </div>
    </section>

    <!-- GAMEPLAY -->
    <section id="game" class="view">
      <div class="row mt-24" style="justify-content:flex-end">
        <div class="oval" id="timer">00:00</div>
      </div>
      <div class="panel">
        <div class="row" style="justify-content:flex-end; font-size:18px; margin-bottom:-8px">
          <div>Q# <span class="qnum" id="qnum">1</span></div>
        </div>
        <div class="question" id="question">1 √ó 1</div>
      </div>
      <input class="answer" id="answer" placeholder="type answer and press Enter" inputmode="numeric" autocomplete="off" />
      <div class="footerBtns">
        <button class="pill primary small" id="quit">QUIT</button>
      </div>
    </section>

    <!-- END SCREEN -->
    <section id="end" class="view center">
      <h2 id="endTitle">YOUR TIME:</h2>
      <div class="oval" id="endStat">00:00</div>
      <div class="footerBtns">
        <button class="pill small" id="replay">Replay</button>
        <button class="pill primary small" data-nav="menu">QUIT</button>
      </div>
      <div class="mt-24" id="saveNote" style="font-size:14px;opacity:.75"></div>
    </section>

    <!-- LEADERBOARD MENU & TABLES -->
    <section id="leaderboards" class="view center">
      <h2>LEADERBOARD</h2>
      <button class="pill alt" data-nav="lb-100s">100s Mode Rankings</button>
      <div class="row">
        <button class="pill alt small" data-nav="lb-30">30s TAM Rankings</button>
        <button class="pill alt small" data-nav="lb-60">1min TAM Rankings</button>
      </div>
      <div class="footerBtns"><button class="pill primary small" data-nav="menu">BACK</button></div>
    </section>

    <section id="lb-100s" class="view center">
      <div class="row" style="justify-content:flex-start"><button class="pill primary small" data-nav="leaderboards">BACK</button></div>
      <h2>100s Mode<br/>LEADERBOARD</h2>
      <table id="tbl100s"><thead><tr><th>RANK</th><th>TIME</th><th>DATE</th></tr></thead><tbody></tbody></table>
    </section>
    <section id="lb-30" class="view center">
      <div class="row" style="justify-content:flex-start"><button class="pill primary small" data-nav="leaderboards">BACK</button></div>
      <h2>30s Time Attack<br/>LEADERBOARD</h2>
      <table id="tbl30"><thead><tr><th>RANK</th><th>SCORE</th><th>DATE</th></tr></thead><tbody></tbody></table>
    </section>
    <section id="lb-60" class="view center">
      <div class="row" style="justify-content:flex-start"><button class="pill primary small" data-nav="leaderboards">BACK</button></div>
      <h2>1 Minute Time Attack<br/>LEADERBOARD</h2>
      <table id="tbl60"><thead><tr><th>RANK</th><th>SCORE</th><th>DATE</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="view center">
      <h2>SETTINGS</h2>
      <label style="display:block; margin:8px auto; width:min(560px,96%); text-align:left">
        <input type="checkbox" id="clearOnIncorrect" /> Clear answer box when incorrect
      </label>
      <label style="display:block; margin:8px auto; width:min(560px,96%); text-align:left">
        <input type="checkbox" id="soundEnabled" checked /> Enable sounds
      </label>
      <div class="footerBtns">
        <button class="pill primary small" data-nav="menu">BACK</button>
      </div>
    </section>

    <!-- Countdown overlay -->
    <div class="countdown" id="countdown"><div id="countVal">3</div></div>
  </div>

  <script>
  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const pad = n => String(n).padStart(2,'0');

  const store = {
    get k(){return {
      hs100s:'hs_100s', hsTA30:'hs_ta_30', hsTA60:'hs_ta_60',
      lb100s:'lb_100s', lb30:'lb_30', lb60:'lb_60',
      settings:'settings'
    }}
  }

  function saveSetting(key, value){
    const s = JSON.parse(localStorage.getItem(store.k.settings) || '{}');
    s[key] = value; localStorage.setItem(store.k.settings, JSON.stringify(s));
  }
  function getSetting(key, def){
    const s = JSON.parse(localStorage.getItem(store.k.settings) || '{}');
    return key in s ? s[key] : def;
  }

  function fmtTime(ms){
    let t = Math.round(ms/1000); const m = Math.floor(t/60), s = t%60; return `${pad(m)}:${pad(s)}`; }

  function parseMMSS(v){
    const m = /^\s*(\d{1,2})[:.](\d{2})\s*$/.exec(v||'');
    if(!m) return 30*1000; // default 30s
    let mm = Math.min(99, parseInt(m[1],10));
    let ss = Math.min(59, parseInt(m[2],10));
    return (mm*60 + ss)*1000;
  }

  // ---------- Sounds ----------
  const sounds = (()=>{
    const enabled = ()=> $('#soundEnabled').checked;
    const make = (name)=>{
      const el = new Audio(name);
      el.preload = 'auto';
      // Fallback beep if file missing
      el.addEventListener('error', ()=>{ el._fallback = true; });
      return el;
    }
    const click = make('click.mp3');
    const correct = make('correct.mp3');
    const incorrect = make('incorrect.mp3');

    function beep(freq=600, dur=120){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.15, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur/1000);
        o.start(); o.stop(ctx.currentTime + dur/1000 + 0.02);
      }catch(e){}
    }

    function play(a){ if(!enabled()) return; if(a._fallback) return beep(); a.currentTime=0; a.play().catch(()=>{}); }
    return { click:()=>play(click), correct:()=>play(correct), incorrect:()=>play(incorrect) };
  })();

  // ---------- Navigation ----------
  function show(id){ $$('.view').forEach(v=>v.classList.remove('active')); $('#'+id).classList.add('active'); }
  function clickNav(){ sounds.click(); show(this.dataset.nav); }
  $$("[data-nav]").forEach(b=> b.addEventListener('click', clickNav));
  $('#btnSettings').onclick = ()=>{ sounds.click(); show('settings'); };
  $('#btnLeaderboard').onclick = ()=>{ sounds.click(); show('leaderboards'); updateLBViews(); };

  // ---------- Highscore top-left ----------
  function refreshTopHS(){ const hs = localStorage.getItem(store.k.hs100s); $('#highscore100s').textContent = hs ? hs : '‚Äî'; }

  // ---------- Operation toggles builder ----------
  const OPS = [ ['add','Addition'], ['sub','Subtraction'], ['mul','Multiplication'], ['div','Division'] ];
  function buildToggles(containerId, defaults={add:1, sub:1, mul:1, div:1}){
    const div = $('#'+containerId); div.innerHTML='';
    OPS.forEach(([key,label])=>{
      const row = document.createElement('div'); row.className='toggle';
      const box = document.createElement('div'); box.className='check '+(defaults[key]?'on':''); box.tabIndex=0; box.role='checkbox'; box.setAttribute('aria-checked', defaults[key]?'true':'false');
      box.onclick = ()=>{ box.classList.toggle('on'); box.setAttribute('aria-checked', box.classList.contains('on')?'true':'false'); sounds.click(); };
      box.onkeydown = (e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); box.click(); } };
      const dot = document.createElement('div'); dot.className='dot'; box.appendChild(dot);
      const text = document.createElement('div'); text.textContent = label;
      row.appendChild(text); row.appendChild(box); div.appendChild(row);
    });
  }

  buildToggles('ops100s');
  buildToggles('opsTA');
  buildToggles('opsPractice');

  // ---------- Settings init ----------
  $('#clearOnIncorrect').checked = getSetting('clearOnIncorrect', false);
  $('#soundEnabled').checked = getSetting('soundEnabled', true);
  $('#clearOnIncorrect').onchange = (e)=> saveSetting('clearOnIncorrect', e.target.checked);
  $('#soundEnabled').onchange = (e)=> saveSetting('soundEnabled', e.target.checked);

  // ---------- Game Engine ----------
  const Game = {
    mode:null, // '100s' | 'TA' | 'Practice'
    ops:null,
    total:null, // 100 for 100s; Infinity for Practice; countdown ms for TA
    remaining:null,
    qnum:1,
    solved:0,
    stopwatchStart:0,
    timerId:null,
    taEndTime:0,
    replayDest:'menu',
    get allOpsOn(){ return ['ops100s','opsTA','opsPractice'].includes(this.opsId) ? $$('#'+this.opsId+' .check').every(x=>x.classList.contains('on')) : false; },
    nextQ(){
      const active = OPS.filter((_,i)=> $('#'+this.opsId+' .check').item(i).classList.contains('on')).map(x=>x[0]);
      if(active.length===0){ alert('Please select at least one operation.'); return null; }
      const op = active[Math.floor(Math.random()*active.length)];
      let a,b,question,answer;
      switch(op){
        case 'add': a=rand(0,100); b=rand(0,100); question=`${a} + ${b}`; answer=a+b; break;
        case 'sub': a=rand(0,100); b=rand(0,100); question=`${a} - ${b}`; answer=a-b; break;
        case 'mul': a=rand(0,12); b=rand(0,12); question=`${a} √ó ${b}`; answer=a*b; break;
        case 'div': b=rand(1,12); a=rand(0,12); const dividend=a*b; question=`${dividend} √∑ ${b}`; answer=a; break;
      }
      return {question, answer};
    }
  }

  function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min }

  function startCountdown(then){
    const overlay = $('#countdown'); const val = $('#countVal'); let n=3; overlay.style.display='flex'; val.textContent=n;
    const id = setInterval(()=>{ n--; if(n>0){ val.textContent=n; } else { clearInterval(id); overlay.style.display='none'; then(); } }, 1000);
  }

  function startGame(mode){
    Game.mode = mode; Game.qnum = 1; Game.solved = 0; $('#answer').value='';
    $('#answer').focus();
    $('#timer').textContent = '00:00'; $('#qnum').textContent = '1';
    show('game');
    startCountdown(()=>{
      Game.stopwatchStart = performance.now();
      if(mode==='TA'){
        const ms = parseMMSS($('#taTime').value);
        Game.taEndTime = performance.now() + ms;
      }
      tick();
      newQuestion();
    });
  }

  function tick(){
    clearInterval(Game.timerId);
    Game.timerId = setInterval(()=>{
      if(Game.mode==='TA'){
        const left = Math.max(0, Game.taEndTime - performance.now());
        $('#timer').textContent = fmtTime(left);
        if(left<=0){ return finish(); }
      }else{
        const elapsed = performance.now() - Game.stopwatchStart;
        $('#timer').textContent = fmtTime(elapsed);
      }
    }, 100);
  }

  function newQuestion(){
    const q = Game.nextQ(); if(!q) return;
    Game.current = q; $('#question').textContent = q.question; $('#answer').value=''; $('#answer').focus(); $('#qnum').textContent = Game.mode==='100s'? Game.qnum : Game.solved+1;
  }

  function onAnswer(e){
    if(e.key!=='Enter') return; const val = $('#answer').value.trim(); if(val==='') return;
    const correct = (Number(val) === Game.current.answer);
    if(correct){
      sounds.correct();
      Game.solved++; Game.qnum++;
      if(Game.mode==='100s' && Game.solved>=100) return finish();
      newQuestion();
    }else{
      sounds.incorrect();
      if(getSetting('clearOnIncorrect', false)) $('#answer').value='';
    }
  }
  $('#answer').addEventListener('keydown', onAnswer);

  function finish(){
    clearInterval(Game.timerId);
    if(Game.mode==='TA'){
      $('#endTitle').textContent = 'YOUR SCORE:'; $('#endStat').textContent = String(Game.solved);
      $('#replay').onclick = ()=>{ sounds.click(); show('setup-ta'); };
      maybeSaveTA(Game.solved);
    }else if(Game.mode==='100s'){
      const elapsed = performance.now() - Game.stopwatchStart; const t = fmtTime(elapsed);
      $('#endTitle').textContent = 'YOUR TIME:'; $('#endStat').textContent = t;
      $('#replay').onclick = ()=>{ sounds.click(); show('setup-100s'); };
      maybeSave100s(t);
    }else{
      $('#endTitle').textContent = 'PRACTICE COMPLETE'; $('#endStat').textContent = '';
      $('#replay').onclick = ()=>{ sounds.click(); show('setup-practice'); };
      $('#saveNote').textContent='';
    }
    show('end');
  }

  function maybeSave100s(t){
    const allOn = $$('#ops100s .check').every(x=>x.classList.contains('on'));
    let note='';
    if(allOn){
      // Save best time (lower is better)
      const prev = localStorage.getItem(store.k.hs100s);
      if(!prev || timeToMs(t) < timeToMs(prev)){
        localStorage.setItem(store.k.hs100s, t); addLB(store.k.lb100s, t);
        note='New personal best saved for 100s mode!';
      }else note='Completed 100 questions. (Play faster to beat your best)';
    }else note='Highscores only save when ALL four operations are selected.';
    $('#saveNote').textContent = note; refreshTopHS();
  }
  function timeToMs(txt){ const [m,s]=txt.split(':').map(Number); return (m*60+s)*1000; }

  function maybeSaveTA(score){
    const allOn = $$('#opsTA .check').every(x=>x.classList.contains('on'));
    const setMs = parseMMSS($('#taTime').value);
    const is30 = setMs===30000, is60 = setMs===60000;
    let note='';
    if(allOn && (is30 || is60)){
      const key = is30? store.k.hsTA30 : store.k.hsTA60;
      const prev = parseInt(localStorage.getItem(key)||'0',10);
      if(score>prev){ localStorage.setItem(key, String(score)); addLB(is30?store.k.lb30:store.k.lb60, score); note=`New personal best saved for ${is30?'30s':'1min'} Time Attack!`; }
      else note='Good run! (Beat your best to update highscore)';
    }else note='TA highscores only save when ALL four operations are on AND time is 30s or 1min.';
    $('#saveNote').textContent = note;
  }

  // Local leaderboard lists (top 100) in localStorage
  function addLB(key, val){
    const arr = JSON.parse(localStorage.getItem(key)||'[]');
    arr.push({v:val, d:new Date().toLocaleDateString()});
    // sort: for 100s (time lower better) detect mm:ss else numeric desc
    arr.sort((a,b)=>{
      const isTime = /:\d{2}$/.test(a.v);
      if(isTime){return timeToMs(a.v)-timeToMs(b.v);} else {return parseInt(b.v,10)-parseInt(a.v,10);} });
    const trimmed = arr.slice(0,100);
    localStorage.setItem(key, JSON.stringify(trimmed));
  }

  function updateLBViews(){
    // Fill tables
    const fill = (key, tblId, label)=>{
      const arr = JSON.parse(localStorage.getItem(key)||'[]');
      const tb = $('#'+tblId+' tbody'); tb.innerHTML='';
      arr.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${r.v}</td><td>${r.d}</td>`; tb.appendChild(tr); });
      if(arr.length===0){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="3">No records yet</td>`; tb.appendChild(tr); }
    }
    fill(store.k.lb100s, 'tbl100s');
    fill(store.k.lb30, 'tbl30');
    fill(store.k.lb60, 'tbl60');
  }

  // ---------- Wire buttons ----------
  $('#start100s').onclick = ()=>{ sounds.click(); Game.opsId='ops100s'; startGame('100s'); };
  $('#startTA').onclick = ()=>{ sounds.click(); Game.opsId='opsTA'; startGame('TA'); };
  $('#startPractice').onclick = ()=>{ sounds.click(); Game.opsId='opsPractice'; startGame('Practice'); };
  $('#quit').onclick = ()=>{ sounds.click(); clearInterval(Game.timerId); show('menu'); };
  $('#replay').onclick = ()=>{}; // set dynamically on finish

  // Time input helper format
  $('#taTime').addEventListener('blur', e=>{ const ms=parseMMSS(e.target.value); e.target.value = fmtTime(ms); });

  // Initialize
  refreshTopHS();

  // Keyboard focus to menu buttons for accessibility
  $('#menu .pill').focus();
  </script>
</body>
</html>
